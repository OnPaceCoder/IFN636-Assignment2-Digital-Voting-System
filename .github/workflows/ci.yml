name: Backend CI

on:
    push:
        branches: ["*"]
    workflow_dispatch: {}
jobs:
    test:
        name: Run Tests
        runs-on: self-hosted

        strategy:
            matrix:
                node-version: [22]
        environment: MONGO_URI

        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            # Set up Node.js
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}

            # Stops all PM2 apps
            - name: Stop PM2 apps
              run: pm2 stop all

            # Install dependencies for backend
            - name: Install Backend Dependencies
              working-directory: ./backend
              run: |
                  npm install --global yarn
                  yarn --version
                  yarn install

            # Install dependencies for frontend
            - name: Install Frontend Dependencies
              working-directory: ./frontend
              env:
                  CI: ""
              run: |
                  df -h
                  sudo rm -rf ./build
                  yarn install
                  yarn run build

            # Run backend tests
            - name: Run Backend Tests
              working-directory: ./backend
              run: npm run test

            - run: npm ci
            - run: |
                  cd ./backend
                  touch .env
                  echo "${{ secrets.PROD }}" > .env

            - run: pm2 start all

            - run: pm2 restart all
